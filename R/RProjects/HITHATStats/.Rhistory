sub_length <- nrow(subq)-1
for (i in 2:sub_length) {
if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]<0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]>0) {
counter <- counter+1
} else if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]>0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
}
}
noyears
length(noyears)
noyears <- data.frame(unique(qfiletempf$wy_val))
noyears
noyears <- data.frame(unique(qfiletempf$wy_val),rownames=FALSE)
noyears
noyears <- data.frame(unique(qfiletempf$wy_val))
str(noyears)
noyears <- data.frame(unique(qfiletempf$wy_val),stringsAsFactors=FALSE)
str(noyears)
noyears
noyears <- data.frame(unique(qfiletempf$wy_val),stringsAsFactors=FALSE)
noyrs <- nrow(noyears)
for (j in 1:noyrs) {
subq <- subset(qfiletempf,qfiletempf$wy_val==noyears[j])
counter <- 0
sub_length <- nrow(subq)-1
for (i in 2:sub_length) {
if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]<0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]>0) {
counter <- counter+1
} else if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]>0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
}
noyears$cnt[j] <- counter
}
qfiletempf$discharge[i+1]-qfiletempf$discharge[i]
qfiletempf$discharge[i]-qfiletempf$discharge[i-1]
i
j
sub_length
subq
subq <- subset(qfiletempf,as.numeric(qfiletempf$wy_val)==noyears[j])
subq
noyears
noyears[j]
noyears <- data.frame(unique(qfiletempf$wy_val),stringsAsFactors=FALSE)
colnames(noyears) <- c("wy_val")
noyrs <- nrow(noyears)
noyears[j]
noyears
noyears$wy_val[j]
for (j in 1:noyrs) {
subq <- subset(qfiletempf,qfiletempf$wy_val==noyears$wy_val[j])
counter <- 0
sub_length <- nrow(subq)-1
for (i in 2:sub_length) {
if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]<0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]>0) {
counter <- counter+1
} else if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]>0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
}
noyears$cnt[j] <- counter
}
noyears
subq
str(qfiletempf)
qfiletempf<-obs_data
str(qfiletempf)
noyears <- data.frame(unique(qfiletempf$wy_val),stringsAsFactors=FALSE)
colnames(noyears) <- c("wy_val")
noyrs <- nrow(noyears)
noyears
j
j<-1
subq <- subset(qfiletempf,qfiletempf$wy_val==noyears$wy_val[j])
counter <- 0
sub_length <- nrow(subq)-1
subq
sub_length
i<-2
if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]<0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]>0) {
counter <- counter+1
} else if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]>0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
}
counter
i<-3
if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]<0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]>0) {
counter <- counter+1
} else if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]>0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
counter
noyears <- data.frame(unique(qfiletempf$wy_val),stringsAsFactors=FALSE)
colnames(noyears) <- c("wy_val")
noyrs <- nrow(noyears)
for (j in 1:noyrs) {
subq <- subset(qfiletempf,qfiletempf$wy_val==noyears$wy_val[j])
counter <- 0
sub_length <- nrow(subq)-1
for (i in 2:sub_length) {
if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]<0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]>0) {
counter <- counter+1
} else if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]>0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
}
noyears$cnt[j] <- counter
}
noyears
View(subq)
i<-3
counter
counter<-0
if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]<0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]>0) {
counter <- counter+1
} else if (qfiletempf$discharge[i+1]-qfiletempf$discharge[i]>0 && qfiletempf$discharge[i]-qfiletempf$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
counter
i
qfiletempf$discharge[i+1]-qfiletempf$discharge[i]
qfiletempf$discharge[i]-qfiletempf$discharge[i-1]
noyears <- data.frame(unique(qfiletempf$wy_val),stringsAsFactors=FALSE)
colnames(noyears) <- c("wy_val")
noyrs <- nrow(noyears)
for (j in 1:noyrs) {
subq <- subset(qfiletempf,qfiletempf$wy_val==noyears$wy_val[j])
counter <- 0
sub_length <- nrow(subq)-1
for (i in 2:sub_length) {
if (subq$discharge[i+1]-subq$discharge[i]<0 && subq$discharge[i]-subq$discharge[i-1]>0) {
counter <- counter+1
} else if (subq$discharge[i+1]-subq$discharge[i]>0 && subq$discharge[i]-subq$discharge[i-1]<0) {
counter <- counter+1
} else {counter<-counter}
}
noyears$cnt[j] <- counter
}
noyears
ra8 <- mean(noyears$cnt)
sd_diff <- sd(noyears$cnt)
ra9 <- (sd_diff*100)/ra8
ra8.9 <- list(ra8=ra8,ra9=ra9)
ra8.9
sdbyyr <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = sd, na.rm=TRUE)
colnames(sdbyyr) <- c("Year", "sdq")
meanbyyr <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
mean, na.rm=TRUE)
colnames(meanbyyr) <- c("Year", "meanq")
dfcvbyyr <- data.frame(meanbyyr$Year, sdbyyr$sdq,
meanbyyr$meanq)
colnames(dfcvbyyr) <- c("Year", "sdq", "meanq")
cvbyyr <- dfcvbyyr$sdq/dfcvbyyr$meanq
dfcvbyyrf <- data.frame(dfcvbyyr, cvbyyr)
colnames(dfcvbyyrf) <- c("Year", "sdq", "meanq",
"cvq")
meancv <- mean(dfcvbyyrf$cvq, na.rm=TRUE)
ma3 <- (meancv) * 100
ma3
medcv <- median(dfcvbyyrf$cvq, na.rm=TRUE)
ma3 <- (medcv) * 100
ma3
hfcrit <- ma2(qfiletempf)
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
peak <- rep(0,nrow(qfiletempf))
nevents <- 1
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$wy_val) == noyears$Year[i])
flag <- 0
peak[i] <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>hfcrit) {
flag <- flag+1
temp <- subsetyr$discharge[j]-hfcrit
nevents <- ifelse(flag==1,nevents+1,nevents)
peak[nevents] <- ifelse(temp>peak[nevents],temp,peak[nevents])
} else {flag <- 0}
}
}
peak_sub <- subset(peak,peak>0)
meanex <- mean(peak_sub)
mh24 <- meanex/ma2(qfiletempf)
mh24
hfcrit <- ma2(qfiletempf)
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
peak <- rep(0,nrow(qfiletempf))
nevents <- 1
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$wy_val) == noyears$Year[i])
flag <- 0
peak[i] <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>hfcrit) {
flag <- flag+1
temp <- subsetyr$discharge[j]
nevents <- ifelse(flag==1,nevents+1,nevents)
peak[nevents] <- ifelse(temp>peak[nevents],temp,peak[nevents])
} else {flag <- 0}
}
}
peak_sub <- subset(peak,peak>0)
meanex <- mean(peak_sub)
mh24 <- meanex/ma2(qfiletempf)
mh24
hfcrit <- 3 * ma2(qfiletempf)
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
peak <- rep(0,nrow(qfiletempf))
nevents <- 1
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$wy_val) == noyears$Year[i])
flag <- 0
peak[i] <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>hfcrit) {
flag <- flag+1
temp <- subsetyr$discharge[j]
nevents <- ifelse(flag==1,nevents+1,nevents)
peak[nevents] <- ifelse(temp>peak[nevents],temp,peak[nevents])
} else {flag <- 0}
}
}
peak_sub <- subset(peak,peak>0)
meanex <- mean(peak_sub)
mh25 <- meanex/ma2(qfiletempf)
mh25
hfcrit <- 7 * ma2(qfiletempf)
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
peak <- rep(0,nrow(qfiletempf))
nevents <- 1
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$wy_val) == noyears$Year[i])
flag <- 0
peak[i] <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>hfcrit) {
flag <- flag+1
temp <- subsetyr$discharge[j]
nevents <- ifelse(flag==1,nevents+1,nevents)
peak[nevents] <- ifelse(temp>peak[nevents],temp,peak[nevents])
} else {flag <- 0}
}
}
peak_sub <- subset(peak,peak>0)
meanex <- mean(peak_sub)
mh26 <- meanex/ma2(qfiletempf)
mh26
isolateq <- qfiletempf$discharge
sortq <- sort(isolateq)
frank75 <- floor(findrank(length(sortq),0.75))
hfcrit75 <- sortq[frank75]
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
peak <- rep(0,nrow(qfiletempf))
nevents <- 1
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$wy_val) == noyears$Year[i])
flag <- 0
peak[i] <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>hfcrit75) {
flag <- flag+1
temp <- subsetyr$discharge[j]
nevents <- ifelse(flag==1,nevents+1,nevents)
peak[nevents] <- ifelse(temp>peak[nevents],temp,peak[nevents])
} else {flag <- 0}
}
}
peak_sub <- subset(peak,peak>0)
meanex <- mean(peak_sub)
mh27 <- meanex/ma2(qfiletempf)
mh27
isolateq <- qfiletempf$discharge
sortq <- sort(isolateq)
frank75 <- floor(findrank(length(sortq),0.25))
hfcrit75 <- sortq[frank75]
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
peak <- rep(0,nrow(qfiletempf))
nevents <- 1
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$wy_val) == noyears$Year[i])
flag <- 0
peak[i] <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>hfcrit75) {
flag <- flag+1
temp <- subsetyr$discharge[j]
nevents <- ifelse(flag==1,nevents+1,nevents)
peak[nevents] <- ifelse(temp>peak[nevents],temp,peak[nevents])
} else {flag <- 0}
}
}
peak_sub <- subset(peak,peak>0)
meanex <- mean(peak_sub)
mh27 <- meanex/ma2(qfiletempf)
mh27
isolateq <- qfiletempf$discharge
sortq <- sort(isolateq)
frank75 <- floor(findrank(length(sortq),0.25))
hfcrit75 <- sortq[frank75]
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$year_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
peak <- rep(0,nrow(qfiletempf))
nevents <- 1
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$year_val) == noyears$Year[i])
flag <- 0
peak[i] <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>hfcrit75) {
flag <- flag+1
temp <- subsetyr$discharge[j]
nevents <- ifelse(flag==1,nevents+1,nevents)
peak[nevents] <- ifelse(temp>peak[nevents],temp,peak[nevents])
} else {flag <- 0}
}
}
peak_sub <- subset(peak,peak>0)
meanex <- mean(peak_sub)
mh27 <- meanex/ma2(qfiletempf)
mh27
hfcrit <- 7 * ma2(qfiletempf)
highflow <- subset(qfiletempf,qfiletempf$discharge>hfcrit)
if (nrow(highflow)>0) {
highbyyr <- aggregate(highflow$discharge,list(highflow$wy_val),FUN=length)
if (pref == "median") {
fh4 <- median(highbyyr$x)
}
else {
fh4 <- mean(highbyyr$x)
}}
else {
fh4 <- 'NA'
}
mean(highbyyr$x)
median(highbyyr$x)
library(XML)
library(zoo)
library(chron)
library(doBy)
library(hydroGOF)
library(RCurl)
sos_url="http://waterservices.usgs.gov/nwis/dv/?format=waterml,1.1&sites="
offering='00003'
property='00060'
drainage_url="http://waterservices.usgs.gov/nwis/site/?siteOutput=Expanded&site="
site_url="http://cida-wiwsc-gdp2qa.er.usgs.gov:8082/geoserver/nwc/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=nwc:se_sites"
sites<-"02178400:"
sites<-"02178400"
startdate<-"1990-10-01"
enddate<-"1999-09-30"
url2<-paste(sos_url,sites,'&startDT=',startdate,'&endDT=',enddate,'&statCd=',offering,'&parameterCd=',property,'&access=3',sep='')
x_obs <- getXMLWML1.1Data(url2)
content <- getURLContent(obs_url,.opts=list(timeout.ms=500000))
test <- capture.output(tryCatch(xmlTreeParse(content, getDTD=F, useInternalNodes=TRUE),"XMLParserErrorList" = function(e) {cat("incomplete",e$message)}))
doc <- htmlTreeParse(content, asText=TRUE, useInternalNodes=TRUE)
obs_url<-url2
content <- getURLContent(obs_url,.opts=list(timeout.ms=500000))
test <- capture.output(tryCatch(xmlTreeParse(content, getDTD=F, useInternalNodes=TRUE),"XMLParserErrorList" = function(e) {cat("incomplete",e$message)}))
doc <- htmlTreeParse(content, asText=TRUE, useInternalNodes=TRUE)
values<-xpathSApply(doc, "//timeseries//value")
values2<-sapply(values,function(x) as.numeric(xmlValue(x)))
dateSet<-xpathSApply(doc, "//@datetime")
dateSet2<-sapply(dateSet,function(x) toString(substr(x,1,10)))
Daily<-as.data.frame(matrix(ncol=2,nrow=length(values2)))
colnames(Daily)<-c('date','discharge')
Daily$discharge<-values2
Daily$date<-as.Date(dateSet2)}
Daily$date<-as.Date(dateSet2)
x_obs<-Daily
x2<-(x_obs$date)
x_obs<-data.frame(x2,x_obs$discharge)
colnames(x_obs)<-c("date","discharge")
selqfile<-x_obs
tempdatafr<-NULL
tempdatafr<-data.frame(selqfile)
month_val<-rep(0,length(tempdatafr$date))
year_val<-rep(0,length(tempdatafr$date))
day_val<-rep(0,length(tempdatafr$date))
jul_val<-rep(0,length(tempdatafr$date))
wy_val<-rep(0,length(tempdatafr$date))
ones_val<-rep(1,length(tempdatafr$date))
qfiletempf<-data.frame(tempdatafr$date,tempdatafr$discharge,month_val,year_val,day_val,jul_val,wy_val)
colnames(qfiletempf)<-c('date','discharge','month_val','year_val','day_val','jul_val','wy_val')
qfiletempf$month_val<-substr(x_obs$date,6,7)
qfiletempf$year_val<-substr(x_obs$date,1,4)
qfiletempf$day_val<-substr(x_obs$date,9,10)
qfiletempf$jul_val<-strptime(x_obs$date, "%Y-%m-%d")$yday+1
qfiletempf$wy_val<-ifelse(as.numeric(qfiletempf$month_val)>=10,as.character(as.numeric(qfiletempf$year_val)+ones_val),qfiletempf$year_val)
obs_data<-qfiletempf
diffbtdays <- diff(qfiletempf$discharge, lag = 1,
differences = 1)
findfallvalueneg <- subset(diffbtdays, diffbtdays <
0)
findfallvalues <- abs(findfallvalueneg)
str(findfallvalues)
diffbtdays <- diff(log10(qfiletempf$discharge), lag = 1,
differences = 1)
findfallvalues <- subset(diffbtdays, diffbtdays <
0)
ra7 <- median(abs(findfallvalues))
ra7
str(diffbtdays)
nmv <- 1
diffs <- rep(99999999,nrow(qfiletempf))
nmv <- 1
for (i in 1:(nrow(qfiletempf)-1)) {
temp <- log10(qfiletempf$discharge[i+1])-log10(qfiletempf$discharge[i])
if (temp<0) {
diffs[nmv] <- temp
nmv <- nmv+1
}
}
nmv
str(diffs)
diffs_neg <- diffs[1:nmv]
diffs_neg
mean(abs(diffs_neg))
diffs_neg <- diffs[1:(nmv-1)]
mean(abs(diffs_neg))
median(abs(diffs_neg))
View(diffs_neg)
str(findfallvalues)
str(diffs_neg)
mean(abs(findfallvalues))
diffs <- rep(99999999,nrow(qfiletempf))
nmv <- 1
for (i in 1:(nrow(qfiletempf)-1)) {
temp <- (qfiletempf$discharge[i+1])-(qfiletempf$discharge[i])
if (temp<0) {
diffs[nmv] <- log10(temp)
nmv <- nmv+1
}
}
warnings()
str(diffs)
diffs <- rep(99999999,nrow(qfiletempf))
nmv <- 1
for (i in 1:(nrow(qfiletempf)-1)) {
temp <- (qfiletempf$discharge[i+1])-(qfiletempf$discharge[i])
if (temp<0) {
diffs[nmv] <- log10(abs(temp))
nmv <- nmv+1
}
}
str(diffs)
diffs_neg <- diffs[1:(nmv-1)]
str(diffs_neg)
median(diffs_net)
median(diffs_neg)
mean(diffs_neg)
library(devtools)
library(devtools)
setwd("C:/Users/jlthomps/Desktop/git/USGS-NWC/R/RProjects/")
load_all("HITHATStats/",reset = TRUE)
library(devtools)
setwd("C:/Users/jlthomps/Desktop/git/USGS-NWC/R/RProjects/")
load_all("HITHATStats/",reset = TRUE)
dh17 <- function(qfiletempf) {
lfcrit <- median(qfiletempf$discharge)
noyears <- aggregate(qfiletempf$discharge, list(qfiletempf$wy_val),
FUN = median, na.rm=TRUE)
colnames(noyears) <- c("Year", "momax")
noyrs <- length(noyears$Year)
dur <- data.frame(Year = rep(0,nrow(qfiletempf)), dur = rep(1,nrow(qfiletempf)))
nevents <- 0
for (i in 1:noyrs) {
subsetyr <- subset(qfiletempf, as.numeric(qfiletempf$wy_val) == noyears$Year[i])
flag <- 0
for (j in 1:nrow(subsetyr)) {
if (subsetyr$discharge[j]>lfcrit) {
flag <- flag+1
nevents <- ifelse(flag==1,nevents+1,nevents)
dur$Year[nevents] <- subsetyr$wy_val[j]
dur$dur[nevents] <- dur$dur[nevents]+1
} else {flag <- 0}
}
}
subset_dur <- dur[1:nevents ,]
meanbyyr <- aggregate(subset_dur$dur, list(subset_dur$Year), mean)
colnames(meanbyyr) <- c("Year", "num_mean")
if (nrow(meanbyyr)>0) {
dh17 <- mean(meanbyyr$num_mean)
} else { dh17<-'NA'}
return(dh17)
}
library(devtools)
setwd("C:/Users/jlthomps/Desktop/git/USGS-NWC/R/RProjects/")
load_all("HITHATStats/",reset = TRUE)
setwd("C:/Users/jlthomps/Desktop/git/USGS-NWC/R/RProjects/HITHATStats")
